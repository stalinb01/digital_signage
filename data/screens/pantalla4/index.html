<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pantalla 4 - Digital Signage</title>
    
    <!-- Estilos de Slides -->
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        background: #000;
        overflow: hidden;
        font-family: Arial, sans-serif;
    }
    
    .slide-container {
        position: relative;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
    }
    
    .slide {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        transition: opacity 1s ease-in-out;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .slide.active {
        opacity: 1;
        z-index: 10;
    }
    
    .slide.fade-out {
        opacity: 0;
    }
    
    /* Transición Fade */
    .transition-fade {
        transition: opacity 1s ease-in-out;
    }
    
    /* Transición Slide */
    .transition-slide {
        transition: transform 1s ease-in-out, opacity 1s ease-in-out;
    }
    
    .transition-slide.slide-in {
        transform: translateX(0);
        opacity: 1;
    }
    
    .transition-slide.slide-out {
        transform: translateX(-100%);
        opacity: 0;
    }
    
    /* Transición Zoom */
    .transition-zoom {
        transition: transform 1.5s ease-in-out, opacity 1s ease-in-out;
    }
    
    .transition-zoom.active {
        transform: scale(1);
    }
    
    .transition-zoom.zoom-out {
        transform: scale(1.2);
        opacity: 0;
    }
    
    .slide img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }
    
    .slide video {
        width: 100vw;
        height: 100vh;
        object-fit: contain;
        background: #000;
    }
    
    .slide iframe {
        width: 100%;
        height: 100%;
        border: none;
    }
    
    .slide [id^="playerContainer-"] {
        width: 100%;
        height: 100%;
    }
    
    .loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 24px;
        z-index: 1000;
    }
</style>
    
    <!-- Estilos de Marquesina (condicional) -->
    
</head>
<body>
    <div class="loading" id="loading">Cargando presentación...</div>
    <div class="slide-container" id="slideContainer"></div>
    
    <!-- Marquesina (condicional) -->
    
    
    <script>
        // Datos de los slides pasados desde Flask
        const slides = [{"id": "slide_1769714248470_n8jil765u", "type": "image", "duration": 13, "transition": "fade", "url": "/static/uploads/20260129_141729_lamina_actividad_arrange_the_story_correct_order.png"}];
        let currentSlideIndex = 0;
        let slideTimeout;
        let isTransitioning = false;
        
        function createSlideElement(slide, index) {
            const div = document.createElement('div');
            div.className = 'slide';
            div.id = 'slide-' + index;

            if (slide.type === 'image') {
                const img = document.createElement('img');
                img.src = slide.url;
                div.appendChild(img);
            } 
            else if (slide.type === 'video') {
                const video = document.createElement('video');
                video.src = slide.url;
                video.autoplay = true;
                video.muted = true;
                video.loop = true;
                div.appendChild(video);
            }
            else if (slide.type === 'youtube') {
                const iframe = document.createElement('iframe');
                const vId = slide.video_id;
                iframe.src = `https://www.youtube.com/embed/${vId}?autoplay=1&mute=1&controls=0&loop=1&playlist=${vId}`;
                iframe.allow = 'autoplay; encrypted-media';
                div.appendChild(iframe);
            }
            return div;
        }
        
        function initSlides() {
            const container = document.getElementById('slideContainer');
            slides.forEach((slide, index) => {
                const slideElement = createSlideElement(slide, index);
                container.appendChild(slideElement);
            });
            
            document.getElementById('loading').style.display = 'none';
            
            if (slides.length > 0) {
                showSlide(0);
            }
        }
        
        function showSlide(index) {
            if (isTransitioning || slides.length === 0) return;
            
            isTransitioning = true;
            const allSlides = document.querySelectorAll('.slide');
            const currentSlide = allSlides[currentSlideIndex];
            const nextSlide = allSlides[index];
            const transition = slides[index].transition || 'fade';
            
            // Limpiar slide actual
            if (currentSlide) {
                const videoId = currentSlide.getAttribute('data-video-id');
                if (videoId) {
                    const video = document.getElementById(videoId);
                    if (video) {
                        video.pause();
                        video.currentTime = 0;
                    }
                }
                
                const youtubeId = currentSlide.getAttribute('data-youtube-id');
                if (youtubeId) {
                    const container = currentSlide.querySelector('[id^="playerContainer-"]');
                    if (container) {
                        container.innerHTML = '';
                    }
                }
                
                if (transition === 'slide') {
                    currentSlide.classList.add('slide-exiting');
                } else if (transition === 'zoom') {
                    currentSlide.classList.add('zoom-exiting');
                } else {
                    currentSlide.classList.add('fade-out');
                }
            }
            
            // Mostrar siguiente slide
            setTimeout(() => {
                if (currentSlide) {
                    currentSlide.classList.remove('active', 'slide-exiting', 'zoom-exiting', 'fade-out');
                }
                
                if (transition === 'slide') {
                    nextSlide.classList.add('slide-entering');
                } else if (transition === 'zoom') {
                    nextSlide.classList.add('zoom-entering');
                }
                
                nextSlide.classList.add('active');
                
                setTimeout(() => {
                    nextSlide.classList.remove('slide-entering', 'zoom-entering');
                    currentSlideIndex = index;
                    isTransitioning = false;
                    
                    const youtubeId = nextSlide.getAttribute('data-youtube-id');
                    const videoId = nextSlide.getAttribute('data-video-id');
                    
                    if (youtubeId) {
                        const container = nextSlide.querySelector('[id^="playerContainer-"]');
                        if (container) {
                            const ancho = window.innerWidth;
                            const alto = window.innerHeight;
                            
                            const iframe = document.createElement('iframe');
                            iframe.id = `ytPlayer-${index}`;
                            iframe.width = ancho;
                            iframe.height = alto;
                            iframe.src = `https://www.youtube.com/embed/${youtubeId}?autoplay=1&mute=1&rel=0&origin=${window.location.origin}`;
                            iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen";
                            iframe.setAttribute('allowfullscreen', '');
                            
                            container.appendChild(iframe);
                        }
                        
                        clearTimeout(slideTimeout);
                        slideTimeout = setTimeout(() => {
                            const nextIndex = (currentSlideIndex + 1) % slides.length;
                            showSlide(nextIndex);
                        }, slides[index].duration * 1000);
                        
                    } else if (videoId) {
                        const video = document.getElementById(videoId);
                        if (video) {
                            video.currentTime = 0;
                            const playPromise = video.play();
                            
                            if (playPromise !== undefined) {
                                playPromise.then(() => {
                                    console.log('Video reproduciendo');
                                }).catch(err => {
                                    console.error('Error reproduciendo video:', err);
                                    setTimeout(() => video.play(), 200);
                                });
                            }
                            
                            clearTimeout(slideTimeout);
                            slideTimeout = setTimeout(() => {
                                video.pause();
                                const nextIndex = (currentSlideIndex + 1) % slides.length;
                                showSlide(nextIndex);
                            }, slides[index].duration * 1000);
                        }
                    } else {
                        clearTimeout(slideTimeout);
                        slideTimeout = setTimeout(() => {
                            const nextIndex = (currentSlideIndex + 1) % slides.length;
                            showSlide(nextIndex);
                        }, slides[index].duration * 1000);
                    }
                }, 50);
            }, transition === 'fade' ? 500 : 800);
        }
        
        // Iniciar presentación
        window.addEventListener('load', () => {
            initSlides();
        });
        
        // Re-ajustar iframes de YouTube al redimensionar
        window.addEventListener('resize', () => {
            document.querySelectorAll('[id^="ytPlayer-"]').forEach(iframe => {
                iframe.width = window.innerWidth;
                iframe.height = window.innerHeight;
            });
        });
        
        // Detener transiciones al salir
        window.addEventListener('beforeunload', () => {
            clearTimeout(slideTimeout);
        });
    </script>
</body>
</html>